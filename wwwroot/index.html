<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8" />
	<title></title>
	<title>SignalR Simple Chat</title>
	<style type="text/css">
		.ws-container {
			background-color: aquamarine;
			border: thick solid #808080;
			padding: 0 20px 20px;
			margin: 20px;
		}

			.ws-container div {
				margin-top: 10px;
			}

			.ws-container .fa-heart {
				margin-left: 10px;
				color: red;
				display: none;
			}

		.ws-title-container {
			display: flex;
			align-items: baseline;
		}

			.ws-title-container div:first-child {
				margin-right: 1em;
			}

		.ws-header {
			font-size: large;
			font-weight: bold;
		}

		.ws-name {
			font-weight: bold;
		}

		.sr-header {
			font-size: large;
			font-weight: bold;
		}

		#ws-ul {
			padding-left: 0;
		}

		.flex-container {
			display: flex;
			justify-content: space-between;
		}
	</style>
	<script src="https://kit.fontawesome.com/bf1dd6efb7.js" crossorigin="anonymous"></script>
</head>
<body>
	<div class="ws-container">
		<div class="ws-title-container">
			<div class="ws-header">iGuardExpress 540</div>
			<div id="status"></div>
			<i class="fas fa-heart"></i>
		</div>
		<div class="flex-container">
			<div class="ws-enter-ip">
				<label for="ws-serial-no">Serial No.:</label>
				<input type="text" id="ws-serial-no" />&nbsp;&nbsp;
				<label for="ws-ip-port">iGuardPayroll IP:Port:</label>
				<input type="text" id="ws-ip-port" />
				<input type="button" id="ws-btn-connect" value="Connect" />
				<span id="ws-ackmsg"></span>
			</div>
			<div>
				<input type="button" id="ws-btn-clear" value="Clear" />
			</div>
		</div>
		<div id="ws-discussion">
			<ul id="ws-ul"></ul>
		</div>
	</div>
	<script type="text/javascript">
		window.onload = function () {

			// let wsUrl = (location.protocol === "https:" ? "wss" : "ws") + "://" + location.host + "/api/websocket";
			let webSocket;
			const wsStatus = document.getElementById("status");
			const wsSerialNo = document.getElementById("ws-serial-no");
			const wsIpPort = document.getElementById("ws-ip-port");
			const wsAckMsg = document.getElementById("ws-ackmsg");
			const wsUl = document.getElementById("ws-ul");
			const wsConnectBtn = document.getElementById("ws-btn-connect");
			const wsClearBtn = document.getElementById("ws-btn-clear");
			const wsHeartBeat = document.querySelectorAll(".ws-container .fa-heart");

			// get/set fake sn @localStorage (201105)
			wsSerialNo.value = window.localStorage.getItem("sn");
			if (!wsSerialNo.value) {
				wsSerialNo.value = "7100-" + Math.floor(Math.random() * (8999) + 1000) + "-" + Math.floor(Math.random() * (8999) + 1000);
				window.localStorage.setItem("sn", wsSerialNo.value);
			}

			// ditto (201105)
			wsIpPort.value = window.localStorage.getItem("ipPort");
			if (!wsIpPort.value) {
				wsIpPort.value = "localhost:50595";
				window.localStorage.setItem("ipPort", wsIpPort.value);
			}

			const connectServer = async () => {
				try {
					wsStatus.innerHTML = "Connecting...";
					const wsUrl = "wss://" + location.host;
					webSocket = new WebSocket(wsUrl);
					webSocket.onopen = function (event) {
						wsStatus.innerHTML = "ONLINE!";
					}
					webSocket.onmessage = function (event) {
						let obj;
						try {
							obj = JSON.parse(event.data);
							console.log("obj:", obj);
							if (obj) {
								if (obj.eventType === 'onConnected') {
									wsAckMsg.innerHTML = obj.data[0];
									wsUl.innerHTML = '';
								} else if (obj.eventType === 'onConnecting' || obj.eventType === 'onReconnecting') {
									wsAckMsg.innerHTML = obj.data[0];
								} else if (obj.eventType === 'onError') {
									wsAckMsg.innerHTML = obj.data[0];
									wsConnectBtn.disabled = false;								
								} else if (obj.eventType === 'heartBeat') {
									wsHeartBeat[0].style.display = "block";
									setTimeout(() => {
										wsHeartBeat[0].style.display = "none"
									}, 400);
								} else {
									wsUl.innerHTML += '<li>' + '<span class="ws-name">' + obj.eventType + '</span>' + ': ' + obj.data + '</li>';
								}
							}
						} catch {
							wsUl.innerHTML += '<li><span class="ws-name">catch</span>: ' + event.data + '</li>';
						}
					}
					webSocket.onclose = async function (event) {
						wsStatus.innerHTML = "WebSocket Closed (code:" + event.code + ", reason:" + event.reason + ")!";
						await new Promise(r => setTimeout(r, 2000));
						connectServer();
					}
				} catch (error) {
					wsStatus.innerHTML = error;
					await new Promise(r => setTimeout(r, 2000));
					connectServer();
				}
			};

			connectServer();

			wsConnectBtn.onclick = () => {
				wsConnectBtn.disabled = true;
				window.localStorage.setItem("ipPort", wsIpPort.value);
				const sendObj = {
					eventType: "onInit",
					data: [{
						SN: wsSerialNo.value,
						IpPort: wsIpPort.value
					}]
				}
				const jsonStr = JSON.stringify(sendObj);
				webSocket.send(jsonStr);
			}

			wsClearBtn.onclick = () => {
				wsUl.innerHTML = "";
			}
		}
	</script>
</body>
</html>