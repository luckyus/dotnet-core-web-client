<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8" />
	<title></title>
	<title>SignalR Simple Chat</title>
	<style type="text/css">
		.ws-container {
			background-color: aquamarine;
			border: thick solid #808080;
			padding: 0 20px 20px;
			margin: 20px;
		}

			.ws-container div {
				margin-top: 10px;
			}

		.ws-title-container {
			display: flex;
			align-items: baseline;
		}

			.ws-title-container div:first-child {
				margin-right: 1em;
			}

		.ws-header {
			font-size: large;
			font-weight: bold;
		}

		.ws-name {
			font-weight: bold;
		}

		.sr-header {
			font-size: large;
			font-weight: bold;
		}
	</style>
</head>
<body>
	<div class="ws-container">
		<div class="ws-title-container">
			<div class="ws-header">WebSocket</div>
			<div id="status"></div>
		</div>
		<div class="ws-user">
			<label for="ws-displayname">Enter Your Name:</label>
			<input type="text" id="ws-displayname" value="brian" />
		</div>
		<div class="ws-enter-ip">
			<label for="ws-displayname">Enter iGuardPayroll IP:Port:</label>
			<input type="text" id="ws-ip-port" value="localhost:44350" />
			<input type="button" id="ws-btn-connect" value="Connect" />
			<span id="ws-ackmsg"></span>
		</div>
		<div class="ws-send-message">
			<label for="ws-send-message">Message:</label>
			<input type="text" id="ws-send-message" />
			<input type="button" id="ws-btn-send" value="Send" />
		</div>
		<div id="ws-discussion">
			<ul id="ws-ul"></ul>
		</div>
	</div>
	<script type="text/javascript">
		window.onload = function () {

			// let wsUrl = (location.protocol === "https:" ? "wss" : "ws") + "://" + location.host + "/api/websocket";
			let webSocket;
			const wsStatus = document.getElementById("status");
			const wsDisplayName = document.getElementById("ws-displayname");
			const wsIpPort = document.getElementById("ws-ip-port");
			const wsAckMsg = document.getElementById("ws-ackmsg");
			const wsSendMsg = document.getElementById("ws-send-message")
			const wsSendBtn = document.getElementById("ws-btn-send");
			const wsUl = document.getElementById("ws-ul");
			const wsConnectBtn = document.getElementById("ws-btn-connect");

			const wsCommand = {
				init: 0,
				ackMsg: 1,
				chatMsg: 2,
				error: 99
			}

			const connectServer = async () => {
				try {
					wsStatus.innerHTML = "Connecting...";
					const wsUrl = "wss://" + location.host;
					webSocket = new WebSocket(wsUrl);
					webSocket.onopen = function (event) {
						wsStatus.innerHTML = "ONLINE!";
					}
					webSocket.onmessage = function (event) {
						let obj;
						try {
							console.log("event.data:", event.data);
							obj = JSON.parse(event.data);
							if (obj) {
								if (obj.command === wsCommand.ackMsg) {
									wsAckMsg.innerHTML = obj.message;
								} else if (obj.command === wsCommand.error) {
									wsConnectBtn.disabled = false;
									wsAckMsg.innerHTML = "Error: " + obj.message;
								} else if (obj.command === wsCommand.chatMsg) {
									wsUl.innerHTML += '<li>' + '<span class="ws-name">' + obj.name + '</span>' + ': ' + obj.message + '</li>';
								} else {
									wsUl.innerHTML += '<li>' + '<span class="ws-name">' + obj.name + '</span>' + ': ' + obj.message + '</li>';
								}
							}
						} catch {
							wsUl.innerHTML += '<li>catch: ' + event.data + '</li>';
						}
					}
					webSocket.onclose = async function (event) {
						wsStatus.innerHTML = "WebSocket Closed (code:" + event.code + ", reason:" + event.reason + ")!";
						await new Promise(r => setTimeout(r, 2000));
						connectServer();
					}
				} catch (error) {
					wsStatus.innerHTML = error;
					await new Promise(r => setTimeout(r, 2000));
					connectServer();
				}
			};

			connectServer();

			wsConnectBtn.onclick = () => {
				wsConnectBtn.disabled = true;
				const sendObj = {
					Command: wsCommand.Init,
					Name: wsDisplayName.value,
					IpPort: wsIpPort.value
				}
				const jsonSendObj = JSON.stringify(sendObj);
				webSocket.send(jsonSendObj);
			}

			wsSendBtn.onclick = function () {
				const sendObj = {
					command: wsCommand.chatMsg,
					name: wsDisplayName.value,
					message: wsSendMsg.value
				}
				const jsonSendObj = JSON.stringify(sendObj);
				console.log(jsonSendObj);
				webSocket.send(jsonSendObj);
			}
		}
	</script>
</body>
</html>