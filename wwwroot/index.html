<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8" />
	<title></title>
	<title>SignalR Simple Chat</title>
	<link rel="stylesheet" type="text/css" href="StyleSheet.css">
	<script src="https://kit.fontawesome.com/bf1dd6efb7.js" crossorigin="anonymous"></script>
</head>
<body>
	<div class="top-menu">
		<div class="flex-container">
			<div class="ws-title-container">
				<div class="ws-header">iGuard 540 / iGuardExpress 540</div>
				<div id="status"></div>
				<i class="fas fa-heart"></i>
			</div>
			<div>
				<span id="ws-ackmsg"></span>
			</div>
		</div>
		<div class="flex-container">
			<div>
				<label for="ws-serial-no">Serial No.:</label>
				<input type="text" id="ws-serial-no" />&nbsp;&nbsp;
				<label for="ws-ip-port">iGuardPayroll:</label>
				<input type="text" id="ws-ip-port" />&nbsp;&nbsp;
				<label for="ws-reg-code">RegCode:</label>
				<input type="text" id="ws-reg-code" />
				<input type="button" id="ws-btn-connect" value="Connect" />
			</div>
			<div>
				<input type="button" id="ws-btn-test" value="Test" disabled />
				<input type="button" id="ws-btn-clear" value="Clear" />
			</div>
		</div>
		<div class="tab">
			<button class="tablinks" data-tab-name="Tab1" onclick="openTab(this, 'Tab1')">AccessLog</button>
			<button class="tablinks" data-tab-name="Tab2" onclick="openTab(this, 'Tab2')">Employee</button>
			<button class="tablinks" data-tab-name="Tab3" onclick="openTab(this, 'Tab3')">Department</button>
		</div>
	</div>
	<div id="Tab1" class="tabcontent flex-container">
		<div>
			<label for="ws-accesslog-card-sn">Card SN:</label>
			<select name="ws-accesslog-card-sn" id="ws-accesslog-card-sn" class="option-cardsn"></select>
			<label for="in-out-status">Status:</label>
			<select name="in-out-status" id="in-out-status">
				<option value="IN">In</option>
				<option value="OUT">Out</option>
				<option value="F1">F1</option>
				<option value="F2">F2</option>
				<option value="F3">F3</option>
				<option value="F4">F4</option>
				<option value="F5">F5</option>
			</select>
			<input type="button" id="btn-accesslog" value="AccessLog" disabled />
			<input type="button" id="btn-accesslogs" value="AccessLogs" disabled />
			<input type="button" id="btn-get-access-right" value="GetAccessRight" disabled />
			<input type="button" id="btn-get-in-out-status" value="GetInOutStatus" disabled />
		</div>
	</div>
	<div id="Tab2" class="tabcontent">
		<div class="flex-container">
			<div>
				<label for="ws-employee-id">ID:</label>
				<input class="employee-id" type="text" id="ws-employee-id" />
				<label for="ws-employee-card-sn">Card SN:</label>
				<select name="ws-employee-card-sn" id="ws-employee-card-sn" class="option-cardsn">
					<option value=''>=== select ===</option>
				</select>
				<label for="ws-employee-lastname">Last Name:</label>
				<input class="employee-name" type="text" id="ws-employee-lastname" />
				<label for="ws-employee-firstname">1st Name:</label>
				<input class="employee-name" type="text" id="ws-employee-firstname" />
				<label for="is-active">Active:</label>
				<select name="is-active" id="is-active">
					<option value="false">False</option>
					<option value="true">True</option>
				</select>
			</div>
		</div>
		<div>
			<input type="button" id="btn-get-status-by-id" value="GetInOutStatus" disabled />
			<input type="button" id="btn-request-permission" value="RequestPermission" disabled />
			<input type="button" id="btn-employee-get" value="Get" disabled />
			<input type="button" id="btn-employee-set" value="Set" disabled />
			<input type="button" id="btn-employee-delete" value="Delete" disabled />
		</div>
	</div>
	<div id="Tab3" class="tabcontent flex-container">
		<div>
			<label for="ws-accesslog-card-sn">Card SN:</label>
			<select name="ws-accesslog-card-sn" id="ws-accesslog-card-sn" class="option-cardsn"></select>
			<label for="in-out-status">Status:</label>
			<select name="in-out-status" id="in-out-status">
				<option value="IN">In</option>
				<option value="OUT">Out</option>
				<option value="F1">F1</option>
				<option value="F2">F2</option>
				<option value="F3">F3</option>
				<option value="F4">F4</option>
				<option value="F5">F5</option>
			</select>
			<input type="button" id="btn-accesslog" value="AccessLog" disabled />
			<input type="button" id="btn-accesslogs" value="AccessLogs" disabled />
			<input type="button" id="btn-get-access-right" value="GetAccessRight" disabled />
			<input type="button" id="btn-get-in-out-status" value="GetInOutStatus" disabled />
		</div>
	</div>
	<div id="ws-discussion">
		<ul id="ws-ul"></ul>
	</div>
	<script type="text/javascript">
		window.onload = function () {
			let webSocket;
			const wsStatus = document.getElementById("status");
			const wsSerialNo = document.getElementById("ws-serial-no");
			const wsIpPort = document.getElementById("ws-ip-port");
			const wsRegCode = document.getElementById("ws-reg-code");
			const wsAckMsg = document.getElementById("ws-ackmsg");
			const wsUl = document.getElementById("ws-ul");
			const wsConnectBtn = document.getElementById("ws-btn-connect");
			const wsTestBtn = document.getElementById("ws-btn-test");
			const wsClearBtn = document.getElementById("ws-btn-clear");
			const wsHeartBeat = document.querySelectorAll("body .fa-heart");
			const accessLogCardSN = document.querySelector("#ws-accesslog-card-sn");
			const accessLogStatus = document.querySelector("#in-out-status");
			const accessLogButton = document.querySelector("#btn-accesslog");
			const accessLogsButton = document.querySelector("#btn-accesslogs");
			const getAccessRightButton = document.querySelector("#btn-get-access-right");
			const getInOutStatusButton = document.querySelector("#btn-get-in-out-status");
			const employeeId = document.querySelector("#ws-employee-id");
			const employeeCardSN = document.querySelector("#ws-employee-card-sn");
			const getStatusByIdButton = document.querySelector('#btn-get-status-by-id');
			const requestPermissionButton = document.querySelector('#btn-request-permission');
			const getEmployeeButton = document.querySelector('#btn-employee-get');
			const setEmployeeButton = document.querySelector('#btn-employee-set');
			const deleteEmployeeButton = document.querySelector('#btn-employee-delete');

			// get/set fake sn @localStorage (201105)
			var storageSN = wsSerialNo.value = window.localStorage.getItem("sn");
			if (!wsSerialNo.value) {
				wsSerialNo.value = "7100-" + Math.floor(Math.random() * (8999) + 1000) + "-" + Math.floor(Math.random() * (8999) + 1000);
				window.localStorage.setItem("sn", wsSerialNo.value);
			}

			// ditto (201105)
			var storageIpPort = wsIpPort.value = window.localStorage.getItem("ipPort");
			if (!wsIpPort.value) {
				wsIpPort.value = "localhost:50595";
				window.localStorage.setItem("ipPort", wsIpPort.value);
			}

			// ditto (221014)
			var storageRegCode = wsRegCode.value = window.localStorage.getItem("regCode");
			if (!wsRegCode.value) {
				wsRegCode.value = "123456";
				window.localStorage.setItem("regCode", wsRegCode.value);
			}

			// setup smartCard SN dropdown (210127)
			const setSmartCardSNDropdown = (snArray) => {
				snArray.forEach(sn => {
					var option = document.createElement('option');
					option.innerHTML = "0x" + sn.toString(16).toUpperCase().padStart(10, '0');
					option.value = sn;
					accessLogCardSN.add(option);
					employeeCardSN.add(option.cloneNode(true));
				});
			};

			const onConnected = () => {
				accessLogButton.disabled = false;
				accessLogsButton.disabled = false;
				getAccessRightButton.disabled = false;
				getInOutStatusButton.disabled = false;
				getStatusByIdButton.disabled = false;
				requestPermissionButton.disabled = false;
				getEmployeeButton.disabled = false;
				setEmployeeButton.disabled = false;
				deleteEmployeeButton.disabled = false;
				wsTestBtn.disabled = false;
			}

			const onDisconnected = () => {
				accessLogButton.disabled = true;
				accessLogsButton.disabled = true;
				getAccessRightButton.disabled = true;
				getInOutStatusButton.disabled = true;
				getStatusByIdButton.disabled = true;
				requestPermissionButton.disabled = true;
				getEmployeeButton.disabled = true;
				setEmployeeButton.disabled = true;
				deleteEmployeeButton.disabled = true;
				wsTestBtn.disabled = true;
			}

			const connectServer = async () => {
				try {
					// for the browser to connect to the app via websocket, not connecting to iGuardPayroll (comment (221007))
					wsStatus.innerHTML = "Connecting...";
					const wsUrl = "wss://" + location.host;
					webSocket = new WebSocket(wsUrl);
					webSocket.onopen = function (event) {
						wsStatus.innerHTML = "ONLINE!";
					}
					webSocket.onmessage = function (event) {
						let obj;
						try {
							obj = JSON.parse(event.data);
							if (obj) {
								if (obj.eventType === 'onConnected') {
									wsAckMsg.innerHTML = obj.data[0];
									wsAckMsg.classList.remove('alert');
									onConnected();
									wsUl.innerHTML = '';
								} else if (obj.eventType === 'onConnecting') {
									wsAckMsg.innerHTML = obj.data[0];
									wsAckMsg.classList.remove('alert');
									setSmartCardSNDropdown(obj.data[1]);
								} else if (obj.eventType === 'onReconnecting') {
									wsAckMsg.classList.remove('alert');
									wsAckMsg.innerHTML = obj.data[0];
								} else if (obj.eventType === 'onError') {
									wsAckMsg.innerHTML = obj.data[0];
									if (wsAckMsg.innerHTML === "The server returned status code '404' when status code '101' was expected.") wsAckMsg.innerHTML += " (orphan?)";
									wsAckMsg.classList.add('alert');
									wsConnectBtn.disabled = false;
								} else if (obj.eventType === 'heartBeat') {
									wsHeartBeat[0].style.display = "block";
									setTimeout(() => {
										wsHeartBeat[0].style.display = "none"
									}, 400);
								} else if (obj.eventType === 'onGetEmployee') {

									console.log("TP#02");
									console.log(obj.data[0]);
									console.log(obj.data[1]);
									console.log(obj.data[2]);
									console.log(obj.data[3]);

									document.querySelector('#ws-employee-lastname').value = obj.data[0];
									document.querySelector('#ws-employee-firstname').value = obj.data[1];
									document.querySelector('#ws-employee-card-sn').value = obj.data[2];
									document.querySelector('#is-active').value = obj.data[3];
								} else {
									// either Tx or Rx (comment (221014))
									var data = JSON.parse(obj.data);
									if (obj.eventType === 'Rx' && ['RegistrationFailed', 'UnRegistered'].includes(data?.eventType)) {
										wsAckMsg.innerHTML = data.data[0];
										wsAckMsg.classList.add('alert');
										wsConnectBtn.disabled = false;
										onDisconnected();
									}
									wsUl.innerHTML += '<li>' + '<span class="ws-name">' + obj.eventType + '</span>' + ': ' + obj.data + '</li>';
								}
							}
						} catch {
							wsUl.innerHTML += '<li><span class="ws-name">catch</span>: ' + event.data + '</li>';
						}
					}
					webSocket.onclose = async function (event) {
						wsStatus.innerHTML = "WebSocket Closed (code:" + event.code + ", reason:" + event.reason + ")!";
						await new Promise(r => setTimeout(r, 2000));
						connectServer();
					}
				} catch (error) {
					wsStatus.innerHTML = error;
					await new Promise(r => setTimeout(r, 2000));
					connectServer();
				}
			};

			connectServer();

			wsConnectBtn.onclick = () => {
				wsUl.innerHTML = null;
				wsConnectBtn.disabled = true;
				if (storageIpPort !== wsIpPort.value) {
					storageIpPort = wsIpPort.value;
					window.localStorage.setItem("ipPort", wsIpPort.value);
				}
				if (storageSN !== wsSerialNo.value) {
					storageSN = wsSerialNo.value;
					window.localStorage.setItem("sn", wsSerialNo.value);
				}
				if (storageRegCode !== wsRegCode.value) {
					storageRegCode = wsRegCode.value;
					window.localStorage.setItem("regCode", wsRegCode.value);
				}
				const jsonObj = {
					eventType: "onConnectClick",
					data: [{
						SN: wsSerialNo.value,
						IpPort: wsIpPort.value,
						RegCode: wsRegCode.value.toUpperCase()
					}]
				}
				const jsonStr = JSON.stringify(jsonObj);
				webSocket.send(jsonStr);
			}

			wsClearBtn.onclick = () => {
				wsUl.innerHTML = "";
			}

			accessLogButton.onclick = () => {
				const jsonObj = {
					eventType: "accessLog",
					data: [{
						cardSN: accessLogCardSN.value,
						status: accessLogStatus.value
					}]
				}
				const jsonStr = JSON.stringify(jsonObj);
				webSocket.send(jsonStr);
			}

			accessLogsButton.onclick = () => {
				const statusArray = Array.from(accessLogStatus.options).map((e) => {
					return e.value;
				});
				const data = Array.from(accessLogCardSN.options).map((e) => {
					return {
						cardSN: e.value,
						status: statusArray[Math.floor(Math.random() * statusArray.length)]
					}
				});
				const jsonObj = {
					eventType: "accessLogs",
					data: data
				}
				const jsonStr = JSON.stringify(jsonObj);
				webSocket.send(jsonStr);
			}

			getAccessRightButton.onclick = () => {
				const jsonObj = {
					eventType: "GetAccessRight",
					data: [{
						smartCardSN: parseInt(accessLogCardSN.value)
					}]
				}
				const jsonStr = JSON.stringify(jsonObj);
				webSocket.send(jsonStr);
			}

			getInOutStatusButton.onclick = () => {
				const jsonObj = {
					eventType: "GetInOutStatus",
					data: [{
						smartCardSN: parseInt(accessLogCardSN.value)
					}]
				}
				const jsonStr = JSON.stringify(jsonObj);
				webSocket.send(jsonStr);
			}

			getStatusByIdButton.onclick = () => {
				const jsonObj = {
					eventType: "GetInOutStatus",
					data: [{
						smartCardSN: 0,
						employeeId: employeeId.value
					}]
				}
				const jsonStr = JSON.stringify(jsonObj);
				webSocket.send(jsonStr);
			}

			requestPermissionButton.onclick = () => {
				const jsonObj = {
					eventType: "RequestPermission",
					data: [{
						employeeId: employeeId.value
					}]
				}
				const jsonStr = JSON.stringify(jsonObj);
				webSocket.send(jsonStr);
			}

			getEmployeeButton.onclick = () => {
				const jsonObj = {
					eventType: "GetEmployee",
					data: [{
						employeeId: employeeId.value == '' ? null : employeeId.value.toUpperCase(),
						smartCardSN: employeeCardSN.value == '' ? null : employeeCardSN.value
					}]
				}
				const jsonStr = JSON.stringify(jsonObj);
				webSocket.send(jsonStr);
			}

			setEmployeeButton.onclick = () => {
				const jsonObj = {
					eventType: "SetEmployee",
					data: [{
						employeeId: employeeId.value.toUpperCase(),
						smartCardSN: employeeCardSN.value === '' ? null : employeeCardSN.value,
						lastName: document.querySelector('#ws-employee-lastname').value,
						firstName: document.querySelector('#ws-employee-firstname').value,
						isActive: document.querySelector('#is-active').value
					}]
				}
				const jsonStr = JSON.stringify(jsonObj);
				webSocket.send(jsonStr);
			}

			deleteEmployeeButton.onclick = () => {
				const jsonObj = {
					eventType: "DeleteEmployee",
					data: [{
						employeeId: employeeId.value.toUpperCase()
					}]
				}
				const jsonStr = JSON.stringify(jsonObj);
				webSocket.send(jsonStr);
			}

			wsTestBtn.onclick = () => {
				const jsonObj = {
					eventType: "onTestClick",
					data: []
				}
				const jsonStr = JSON.stringify(jsonObj);
				webSocket.send(jsonStr);
			}
		}
	</script>
	<script src="JavaScript.js"></script>
</body>
</html>